<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Super Spinny Brawl</title>
<style>
    body {
        background: #0a0a0c;
        color: #00ffcc;
        text-align: center;
        font-family: 'Courier New', monospace;
        overflow: hidden;
        margin: 0;
        touch-action: none;
    }
    canvas {
        background: #050505;
        border: 2px solid #00ffcc;
        display: none;
        margin: 10px auto;
        box-shadow: 0 0 30px #004433;
        max-width: 95vw;
        max-height: 60vh;
    }
    .hud {
        display: none;
        justify-content: center;
        align-items: center;
        gap: 30px;
        font-size: 25px;
        margin-top: 10px;
        text-shadow: 0 0 10px #00ffcc;
    }
    .timer {
        font-size: 35px;
        color: #fff;
        border: 2px solid #fff;
        padding: 5px 15px;
        min-width: 80px;
    }
    .p1 { color: #00d2ff; }
    .p2 { color: #ff0055; }

    .win-msg, #countdown, #pauseMenu {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 40px;
        background: rgba(0,0,0,0.95);
        padding: 30px;
        display: none;
        border: 2px solid #00ffcc;
        z-index: 100;
        color: #fff;
        text-align: center;
        border-radius: 10px;
    }

    #menu, #onlineMenu {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border: 2px solid #00ffcc;
        background: #050505;
        padding: 30px;
        box-shadow: 0 0 50px #004433;
        z-index: 20;
        width: 80%;
        max-width: 400px;
    }

    #onlineMenu {
        display: none;
        z-index: 25;
    }

    .btn {
        display: block;
        width: 100%;
        padding: 15px;
        margin: 10px auto;
        background: transparent;
        color: #00ffcc;
        border: 1px solid #00ffcc;
        font-family: 'Courier New', monospace;
        font-size: 18px;
        cursor: pointer;
    }

    .diff-container {
        display: flex;
        gap: 5px;
        justify-content: center;
        margin-bottom: 20px;
    }
    .diff-btn {
        padding: 8px;
        font-size: 12px;
        border: 1px solid #666;
        color: #666;
        background: none;
        flex: 1;
    }
    .diff-btn.active {
        border-color: #00ffcc;
        color: #00ffcc;
    }

    /* Touch Controls */
    #touchUI {
        position: fixed;
        bottom: 20px;
        left: 0;
        width: 100%;
        display: none;
        justify-content: space-between;
        padding: 0 20px;
        box-sizing: border-box;
        pointer-events: none;
        z-index: 50;
    }
    .t-group {
        display: flex;
        gap: 15px;
        pointer-events: auto;
    }
    .t-btn {
        width: 70px;
        height: 70px;
        background: rgba(0, 255, 204, 0.15);
        border: 2px solid #00ffcc;
        border-radius: 50%;
        color: #00ffcc;
        font-size: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        user-select: none;
        -webkit-user-select: none;
    }
    .t-btn:active {
        background: rgba(0, 255, 204, 0.4);
        transform: scale(1.1);
    }
    #tPause {
        position: fixed;
        top: 15px;
        right: 15px;
        width: 50px;
        height: 50px;
        border-radius: 5px;
        font-size: 18px;
        pointer-events: auto;
    }
</style>
</head>
<body>

<div id="menu">
    <h1>SUPER SPINNY BRAWL</h1>
    <p>AI DIFFICULTY</p>
    <div class="diff-container">
        <button class="diff-btn" onclick="setDiff(0.5, 60, this)">EASY</button>
        <button class="diff-btn active" onclick="setDiff(1, 35, this)">MED</button>
        <button class="diff-btn" onclick="setDiff(1.6, 15, this)">HARD</button>
    </div>
    <button class="btn" onclick="preStart(true)">1P VS BOT</button>
    <button class="btn" onclick="preStart(false)">2P LOCAL</button>
    <button class="btn" onclick="openOnlineMenu()">SpinnyWFC</button>
</div>

<div id="onlineMenu">
    <h1>SpinnyWFC</h1>
    <button class="btn" onclick="quickMatch()">QUICK MATCH</button>
    <button class="btn" onclick="openGamestats()">GAMESTATS</button>
    <button class="btn" onclick="logout()">LOGOUT</button>
    <button class="btn" onclick="closeOnlineMenu()" style="margin-top:20px;">BACK</button>
</div>

<div id="pauseMenu">
    <div style="font-size: 25px; margin-bottom: 15px;">PAUSED</div>
    <button class="btn" onclick="togglePause()">RESUME</button>
    <button class="btn" onclick="location.reload()">MENU</button>
</div>

<div id="touchUI">
    <div class="t-group">
        <div class="t-btn" id="btnLeft">←</div>
        <div class="t-btn" id="btnRight">→</div>
    </div>
    <div class="t-group">
        <div class="t-btn" id="btnUp">↑</div>
        <div class="t-btn" id="btnAtk">⚔️</div>
    </div>
    <div class="t-btn" id="tPause" onclick="togglePause()">II</div>
</div>

<div id="countdown"></div>
<div id="winMsg" class="win-msg"></div>

<div id="hud" class="hud">
    <div class="p1">C: <span id="p1%">0</span>%</div>
    <div id="timer" class="timer">60</div>
    <div class="p2"><span id="p2Label">BOT</span>: <span id="p2%">0</span>%</div>
</div>

<canvas id="game" width="900" height="500"></canvas>

<script>

  const socket = new WebSocket("wss://superspinnybrawlserver.onrender.com");

  // ⭐ ADDED — role + opponent keys
  let myRole = null;
  let opponentKeys = { w:false, a:false, d:false, attack:false };

  socket.onopen = () => {
    console.log("Connected to server");
  };

  socket.onmessage = (event) => {
    console.log("Received:", event.data);

    // ⭐ MATCH FOUND
    if (event.data === "match_found") {
      const btn = document.querySelector('button[onclick="quickMatch()"]');
      if (btn) btn.textContent = "MATCH FOUND!";

      // ⭐⭐⭐ REQUIRED FIX — START ONLINE MATCH ⭐⭐⭐
      preStart(false);

      return;
    }

    // ⭐ ADDED — JSON messages
    try {
      const data = JSON.parse(event.data);

      // ⭐ ADDED — server assigns role
      if (data.type === "role") {
        myRole = data.role;
        console.log("Assigned role:", myRole);
      }

      // ⭐ ADDED — opponent input arrives
      if (data.type === "opponent_input") {
        opponentKeys = data.keys;
      }

      // ⭐ ADDED — opponent disconnected
      if (data.type === "opponent_disconnect") {
        alert("Opponent disconnected");
        location.reload();
      }

    } catch (e) {
      // ignore non‑JSON
    }
  };

  // ⭐ Your REAL Quick Match function (kept exactly as-is)
function quickMatch() {
  document.querySelector('button[onclick="quickMatch()"]').textContent = "SEARCHING...";
  socket.send("quick_match");
}


const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let gameRunning = false,
    isPaused = false,
    botSpeedMult = 1,
    botAggression = 35,
    timeLeft = 60,
    particles = [],
    p1, p2,
    timerInterval;

const keys = {};

// Touch Logic
function bindTouch(id, key) {
    const el = document.getElementById(id);
    el.addEventListener('touchstart', (e) => {
        e.preventDefault();
        keys[key] = true;
    });
    el.addEventListener('touchend', (e) => {
        e.preventDefault();
        keys[key] = false;
    });
}
bindTouch('btnLeft', 'a');
bindTouch('btnRight', 'd');
bindTouch('btnUp', 'w');
bindTouch('btnAtk', ' ');

function setDiff(speed, aggro, btn) {
    botSpeedMult = speed;
    botAggression = aggro;
    document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

function preStart(vsBot) {
    document.getElementById("menu").style.display = "none";
    document.getElementById("onlineMenu").style.display = "none";
    document.getElementById("game").style.display = "block";
    document.getElementById("hud").style.display = "flex";
    document.getElementById("touchUI").style.display = "flex";

    p1 = new Fighter(300, "#00d2ff", {up:'w', left:'a', right:'d', attack:' '}, "p1", "C:");
    p2 = new Fighter(600, "#ff0055", {up:'ArrowUp', left:'ArrowLeft', right:'ArrowRight', attack:'Enter'}, "p2", vsBot ? "BOT" : "D:", vsBot);
    document.getElementById("p2Label").innerText = vsBot ? "BOT" : "D:";

    let count = 3;
    const cdDiv = document.getElementById("countdown");
    cdDiv.style.display = "block";
    cdDiv.innerText = count;

    const cdInterval = setInterval(() => {
        count--;
        if (count > 0) cdDiv.innerText = count;
        else if (count === 0) cdDiv.innerText = "GO!";
        else {
            clearInterval(cdInterval);
            cdDiv.style.display = "none";
            gameRunning = true;
            startTimer();
            loop();
        }
    }, 800);
}

function startTimer() {
    timerInterval = setInterval(() => {
        if (gameRunning && !isPaused) {
            timeLeft--;
            document.getElementById("timer").innerText = timeLeft;
            if (timeLeft <= 0) {
                gameRunning = false;
                endGame(p1.percent < p2.percent ? "P1 WINS" : "P2 WINS");
                clearInterval(timerInterval);
            }
        }
    }, 1000);
}

function togglePause() {
    if (!gameRunning) return;
    isPaused = !isPaused;
    document.getElementById("pauseMenu").style.display = isPaused ? "block" : "none";
}

class Fighter {
    constructor(x, color, controls, name, label, isBot = false) {
        this.x = x;
        this.y = 200;
        this.w = 45;
        this.h = 60;
        this.color = color;
        this.controls = controls;
        this.name = name;
        this.label = label;
        this.vx = 0;
        this.vy = 0;
        this.percent = 0;
        this.isBot = isBot;
        this.jumpCount = 0;
        this.maxJumps = 2;
        this.dir = 1;
        this.canJump = true;
        this.attackCooldown = 0;
    }

    // ⭐ ADDED — apply opponent network input
    applyNetworkInput(k) {
        if (k.a) {
            this.vx = -5.5;
            this.dir = -1;
        } else if (k.d) {
            this.vx = 5.5;
            this.dir = 1;
        } else {
            this.vx *= 0.88;
        }

        if (k.w) {
            if (this.canJump && this.jumpCount < this.maxJumps) {
                this.vy = -13;
                this.jumpCount++;
                this.canJump = false;
            }
        } else {
            this.canJump = true;
        }

        if (k.attack) {
            this.performAttack(p1 === this ? p2 : p1);
        }
    }

    update(keys, opponent) {
        if (!gameRunning || isPaused) return;

        if (this.isBot) {
            this.handleAI(opponent);
        }

        // ⭐ ADDED — network-controlled fighter
        else if (this.name === "p2" && myRole === "p1") {
            this.applyNetworkInput(opponentKeys);
        }
        else if (this.name === "p1" && myRole === "p2") {
            this.applyNetworkInput(opponentKeys);
        }

        else {
            if (keys[this.controls.left]) {
                this.vx = -5.5;
                this.dir = -1;
            } else if (keys[this.controls.right]) {
                this.vx = 5.5;
                this.dir = 1;
            } else {
                this.vx *= 0.88;
            }

            if (keys[this.controls.up]) {
                if (this.canJump && this.jumpCount < this.maxJumps) {
                    this.vy = -13;
                    this.jumpCount++;
                    this.canJump = false;
                }
            } else {
                this.canJump = true;
            }

            if (keys[this.controls.attack]) {
                this.performAttack(opponent);
                keys[this.controls.attack] = false;
            }
        }

        this.vy += 0.55;
        this.x += this.vx;
        this.y += this.vy;

        if (this.x + this.w > 200 && this.x < 700 && this.y + this.h > 400 && this.y < 420 && this.vy >= 0) {
            this.y = 400 - this.h;
            this.vy = 0;
            this.jumpCount = 0;
        }

        if (this.x < -150 || this.x > canvas.width + 150 || this.y < -150 || this.y > canvas.height + 150)
            this.respawn();
    }

    handleAI(target) {
        let speed = 4.5 * botSpeedMult;

        if (this.x < 220) {
            this.vx = speed;
            if (this.jumpCount < 2) {
                this.vy = -13;
                this.jumpCount++;
            }
        } else if (this.x > 630) {
            this.vx = -speed;
            if (this.jumpCount < 2) {
                this.vy = -13;
                this.jumpCount++;
            }
        } else {
            if (target.x < this.x - 30) {
                this.vx = -speed;
                this.dir = -1;
            } else if (target.x > this.x + 30) {
                this.vx = speed;
                this.dir = 1;
            } else {
                this.vx *= 0.8;
            }
        }

        this.attackCooldown--;
        if (Math.abs(target.x - this.x) < 70 && Math.abs(this.y - target.y) < 50 && this.attackCooldown <= 0) {
            this.performAttack(target);
            this.attackCooldown = botAggression;
        }
    }

    performAttack(opponent) {
        let hitX = this.x + (this.dir === 1 ? 40 : -40);
        if (hitX < opponent.x + opponent.w && hitX + 30 > opponent.x && Math.abs(this.y - opponent.y) < 60)
            opponent.takeHit(this.dir);
    }

    takeHit(direction) {
        this.percent += 12;
        let kb = 5 + (this.percent * 0.25);
        this.vx = direction * kb;
        this.vy = -kb * 0.4;
        document.getElementById(this.name + "%").innerText = this.percent;
    }

    respawn() {
        this.percent = 0;
        this.x = 450;
        this.y = 100;
        this.vx = 0;
        this.vy = 0;
        document.getElementById(this.name + "%").innerText = 0;
        for (let i = 0; i < 15; i++)
            particles.push({x: 450, y: 100, vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10, a: 1});
    }

    draw() {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.fillStyle = "#333";
        ctx.fillRect(0, 0, this.w, this.h);
        ctx.strokeStyle = this.color;
        ctx.lineWidth = 2;
        ctx.strokeRect(0, 0, this.w, this.h);
        ctx.fillStyle = "white";
        ctx.font = "bold 10px Courier";
        ctx.fillText(this.label, 5, 15);
        ctx.restore();
    }
}

function endGame(w) {
    const m = document.getElementById("winMsg");
    m.innerHTML = "TIME UP!<br><span style='font-size:25px'>"+w+"</span>";
    m.style.display = "block";
    setTimeout(() => location.reload(), 4000);
}

window.onkeydown = (e) => {
    keys[e.key] = true;
    if(e.key.toLowerCase() === 'b') togglePause();
};
window.onkeyup = (e) => keys[e.key] = false;

// ⭐ ADDED — send inputs every frame
function sendInputs() {
    if (!myRole) return;

    const keysToSend = {
        w: keys["w"] || keys["ArrowUp"],
        a: keys["a"] || keys["ArrowLeft"],
        d: keys["d"] || keys["ArrowRight"],
        attack: keys[" "] || keys["Enter"]
    };

    socket.send(JSON.stringify({
        type: "input",
        keys: keysToSend
    }));
}

function loop() {

    // ⭐ ADDED — send inputs at start of frame
    sendInputs();

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#002211";
    ctx.fillRect(200, 400, 500, 15);
    ctx.strokeStyle = "#00ffcc";
    ctx.strokeRect(200, 400, 500, 15);

    p1.update(keys, p2);
    p2.update(keys, p1);
    p1.draw();
    p2.draw();

    for (let i = particles.length - 1; i >= 0; i--) {
        let p = particles[i];
        p.x += p.vx;
        p.y += p.vy;
        p.a -= 0.02;
        ctx.globalAlpha = p.a;
        ctx.fillStyle = "#fff";
        ctx.fillRect(p.x, p.y, 3, 3);
        if (p.a <= 0) particles.splice(i, 1);
    }
    ctx.globalAlpha = 1;

    if (gameRunning) requestAnimationFrame(loop);
}

/* ONLINE MENU PLACEHOLDERS */
function openOnlineMenu() {
    document.getElementById("menu").style.display = "none";
    document.getElementById("onlineMenu").style.display = "block";
}
function closeOnlineMenu() {
    document.getElementById("onlineMenu").style.display = "none";
    document.getElementById("menu").style.display = "block";
}

// ⭐ RENAMED so it doesn't overwrite your real quickMatch()
function quickMatchPlaceholder() {
    alert("I'm not sure if quickmatch works, it should be searching p2p.");
}

function openGamestats() {
    alert("I haven't done gamestats yet.");
}
function logout() {
    alert("Disconnected from SpinnyWFC");
}
</script>

</body>
</html>
